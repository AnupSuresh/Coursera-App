<!doctype html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <script src="/js/axiosInstance.js"></script>
      <title>Course Admin Panel</title>
      <style>
         body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
         }
         h2,
         h3 {
            color: #333;
         }

         .form-container,
         .course-list {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
         }

         .form-container input,
         .form-container textarea,
         .form-container button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
         }

         .form-container button {
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: 0.2s;
         }
         .form-container button:hover {
            background-color: #0056b3;
         }

         .course-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
         }

         .course-card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
         }

         .course-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
         }

         .course-card .content {
            padding: 15px;
            flex-grow: 1;
         }

         .course-card .actions {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-top: 1px solid #eee;
            gap: 5px;
         }

         .course-card .actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
         }

         .btn-warning {
            background-color: #ffc107;
            color: #fff;
         }
         .btn-warning:hover {
            background-color: #e0a800;
         }
         .btn-danger {
            background-color: #dc3545;
            color: #fff;
         }
         .btn-danger:hover {
            background-color: #c82333;
         }
         .btn-success {
            background-color: #28a745;
            color: #fff;
         }
         .btn-success:hover {
            background-color: #218838;
         }
         .btn-secondary {
            background-color: #6c757d;
            color: #fff;
         }
         .btn-secondary:hover {
            background-color: #5a6268;
         }
         .btn-info {
            background-color: #17a2b8;
            color: #fff;
         }
         .btn-info:hover {
            background-color: #138496;
         }

         .hidden {
            display: none !important;
         }

         .content-management {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
         }

         .lesson-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
         }

         .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
         }

         .lesson-actions {
            display: flex;
            gap: 5px;
         }

         .lesson-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
         }

         .note-item {
            background: #e9ecef;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
         }

         .note-actions {
            display: flex;
            gap: 5px;
         }

         .note-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
         }

         .file-input-group {
            display: flex;
            gap: 10px;
            align-items: end;
         }

         .file-input-group input[type="file"] {
            flex: 1;
            margin: 0;
         }

         .file-input-group button {
            margin: 0;
            padding: 10px 15px;
            white-space: nowrap;
            width: auto;
         }

         .back-btn {
            background-color: #6c757d;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
         }
         .back-btn:hover {
            background-color: #5a6268;
         }

         .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
         }
         .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
         }
      </style>
   </head>
   <body>
      <h2>Course Admin Panel</h2>

      <!-- Course Creation/Update Form -->
      <div class="form-container" id="course-form">
         <h3 id="form-title">Create Course</h3>
         <input type="text" id="title" placeholder="Course Title" />
         <input type="text" id="description" placeholder="Course Description" />
         <input
            type="number"
            id="price"
            placeholder="Course Price"
            min="0"
            step="0.01"
         />
         <input type="file" id="thumbnail-image" accept="image/*" />
         <small style="color: #666">Accepted: JPG, PNG, GIF. Max 5MB</small>
         <button id="submit-course">Create Course</button>
         <button id="cancel-update" class="btn-secondary" style="display: none">
            Cancel Update
         </button>
      </div>

      <!-- Course Content Management -->
      <div class="content-management hidden" id="content-management">
         <button class="back-btn" id="back-to-courses">
            ‚Üê Back to Courses
         </button>
         <h3 id="content-course-title">Manage Course Content</h3>

         <div class="form-container">
            <h4 id="lesson-form-title">Add New Lesson</h4>
            <input type="text" id="lesson-title" placeholder="Lesson Title" />
            <input type="file" id="lesson-video" accept="video/*" />
            <small style="color: #666"
               >Accepted: MP4, WebM, MOV. Max 500MB</small
            >
            <p
               id="current-video-info"
               style="font-size: 12px; color: #666; display: none"
            >
               Current video will be kept if no new video is selected
            </p>
            <input
               type="number"
               id="lesson-duration"
               placeholder="Duration (minutes)"
               min="1"
            />

            <h5>Add Notes/Files</h5>
            <div class="file-input-group">
               <input
                  type="file"
                  id="lesson-file"
                  multiple
                  accept=".pdf,.txt,.md,.docx,.pptx,.jpg,.jpeg,.png,.json,.html"
               />
               <button type="button" id="add-files" class="btn-info">
                  Add Files
               </button>
            </div>
            <small style="color: #666">Max 10MB per file</small>

            <div id="selected-files"></div>
            <button id="add-lesson">Add Lesson</button>
            <button
               id="cancel-lesson-update"
               class="btn-secondary"
               style="display: none"
            >
               Cancel Update
            </button>
         </div>

         <div id="lessons-list">
            <h4>Course Lessons</h4>
            <div id="lessons-container"></div>
         </div>
      </div>

      <!-- Course List -->
      <div class="course-list" id="course-list"></div>

      <script>
         let editingCourseId = null;
         let currentCourseId = null;
         let currentContentId = null;
         let selectedFiles = [];
         let editingLessonId = null;
         let editingLessonNotes = [];

         const MAX_IMAGE_SIZE = 5 * 1024 * 1024; // 5MB
         const MAX_VIDEO_SIZE = 500 * 1024 * 1024; // 500MB
         const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

         function validateFileSize(file, maxSize, type) {
            if (file.size > maxSize) {
               alert(
                  `${type} file is too large. Maximum size: ${maxSize / (1024 * 1024)}MB`
               );
               return false;
            }
            return true;
         }

         async function loadCourses() {
            try {
               const res = await axiosInstance.get("/course/preview");
               const courses = res.data.courses;
               const courseList = document.getElementById("course-list");
               courseList.innerHTML = "";

               if (courses.length === 0) {
                  courseList.innerHTML =
                     '<div class="alert alert-info">No courses created yet. Create your first course above!</div>';
                  return;
               }

               courses.forEach((course) => {
                  const div = document.createElement("div");
                  div.className = "course-card";
                  div.innerHTML = `
                  <img src="${course["thumbnail-image"]?.url || "https://via.placeholder.com/250x160?text=No+Image"}" alt="thumbnail"/>
                  <div class="content">
                     <h4>${course.title}</h4>
                     <p>${course.description}</p>
                     <p><strong>Price:</strong> $${course.price}</p>
                  </div>
                  <div class="actions">
                     <button class="btn-warning" data-id="${course._id}">Update</button>
                     <button class="btn-success" data-id="${course._id}" data-title="${course.title}">Content</button>
                     <button class="btn-danger" data-id="${course._id}">Delete</button>
                  </div>
               `;
                  courseList.appendChild(div);
               });

               document.querySelectorAll(".btn-warning").forEach((btn) => {
                  btn.addEventListener("click", (e) => {
                     const courseId = e.target.dataset.id;
                     const course = courses.find((c) => c._id === courseId);
                     startUpdate(courseId, course);
                  });
               });

               document.querySelectorAll(".btn-success").forEach((btn) => {
                  btn.addEventListener("click", (e) => {
                     const courseId = e.target.dataset.id;
                     const courseTitle = e.target.dataset.title;
                     showContentManagement(courseId, courseTitle);
                  });
               });

               document.querySelectorAll(".btn-danger").forEach((btn) => {
                  btn.addEventListener("click", async (e) => {
                     const courseId = e.target.dataset.id;
                     await deleteCourse(courseId);
                  });
               });
            } catch (error) {
               console.error(
                  "Failed to load courses:",
                  error.response?.data || error.message
               );
               document.getElementById("course-list").innerHTML =
                  '<div class="alert alert-info">Error loading courses. Please refresh the page.</div>';
            }
         }

         function showContentManagement(courseId, courseTitle) {
            currentCourseId = courseId;
            document.getElementById("course-form").classList.add("hidden");
            document.getElementById("course-list").classList.add("hidden");
            document
               .getElementById("content-management")
               .classList.remove("hidden");
            document.getElementById("content-course-title").textContent =
               `Manage Content: ${courseTitle}`;
            loadCourseContent(courseId);
         }

         function showCourseList() {
            document.getElementById("course-form").classList.remove("hidden");
            document.getElementById("course-list").classList.remove("hidden");
            document
               .getElementById("content-management")
               .classList.add("hidden");
            currentCourseId = null;
            currentContentId = null;
            resetLessonForm();
         }

         async function loadCourseContent(courseId) {
            try {
               const res = await axiosInstance.get(
                  `/course/${courseId}/content`
               );
               const data = res.data;

               // FIX: Properly set currentContentId
               currentContentId =
                  data.courseContent?.id || data.courseContent?._id;
               const lessons = data.courseContent?.lessons || [];
               const container = document.getElementById("lessons-container");

               if (lessons.length > 0) {
                  container.innerHTML = "";
                  lessons.forEach((lesson, index) => {
                     const lessonDiv = document.createElement("div");
                     lessonDiv.className = "lesson-item";

                     const lessonId = lesson._id || lesson.id;
                     const videoKey = lesson.video?.key || "N/A";

                     lessonDiv.innerHTML = `
                        <div class="lesson-header">
                           <h4>Lesson ${index + 1}: ${lesson.title}</h4>
                           <div class="lesson-actions">
                              <button class="btn-warning" data-lesson-id="${lessonId}" data-lesson-index="${index}">Edit</button>
                              <button class="btn-danger" data-lesson-id="${lessonId}">Delete</button>
                           </div>
                        </div>
                        <p><strong>Duration:</strong> ${lesson.duration} minutes</p>
                        <p><strong>Video:</strong> ${videoKey}</p>
                        <div class="notes-list">
                           <p><strong>Notes:</strong> ${lesson.notes?.length || 0} files</p>
                           ${(lesson.notes || [])
                              .map(
                                 (note) => `
                              <div class="note-item">
                                 <span>${note.fileName}</span>
                                 <div class="note-actions">
                                    <button class="btn-danger" data-note-id="${note._id || note.id}">Delete</button>
                                 </div>
                              </div>
                           `
                              )
                              .join("")}
                        </div>
                     `;

                     container.appendChild(lessonDiv);

                     // Attach event listeners
                     lessonDiv
                        .querySelector(".btn-warning")
                        .addEventListener("click", () => {
                           editLesson(
                              lessonId,
                              lesson.title,
                              lesson.duration,
                              lesson.notes || []
                           );
                        });

                     lessonDiv
                        .querySelector(".lesson-actions .btn-danger")
                        .addEventListener("click", () => {
                           deleteLesson(lessonId);
                        });

                     lessonDiv
                        .querySelectorAll(".note-actions .btn-danger")
                        .forEach((noteBtn, noteIndex) => {
                           noteBtn.addEventListener("click", () => {
                              const noteId =
                                 lesson.notes[noteIndex]._id ||
                                 lesson.notes[noteIndex].id;
                              deleteNote(noteId);
                           });
                        });
                  });
               } else {
                  container.innerHTML =
                     '<div class="alert alert-info">No lessons added yet. Add your first lesson above!</div>';
               }
            } catch (error) {
               console.error("Failed to load course content:", error);
               const container = document.getElementById("lessons-container");
               if (
                  error.response?.status === 403 ||
                  error.response?.status === 404
               ) {
                  container.innerHTML =
                     '<div class="alert alert-info">This course has no content yet.</div>';
               } else {
                  container.innerHTML =
                     '<div class="alert alert-info">Error loading course content.</div>';
               }
            }
         }

         function startUpdate(courseId, course) {
            editingCourseId = courseId;
            document.getElementById("form-title").innerText = "Update Course";
            document.getElementById("title").value = course.title;
            document.getElementById("description").value = course.description;
            document.getElementById("price").value = course.price;
            document.getElementById("submit-course").innerText =
               "Update Course";
            document.getElementById("cancel-update").style.display =
               "inline-block";
            window.scrollTo({ top: 0, behavior: "smooth" });
         }

         function resetForm() {
            document.getElementById("form-title").innerText = "Create Course";
            document.getElementById("title").value = "";
            document.getElementById("description").value = "";
            document.getElementById("price").value = "";
            document.getElementById("thumbnail-image").value = "";
            document.getElementById("submit-course").innerText =
               "Create Course";
            document.getElementById("cancel-update").style.display = "none";
            editingCourseId = null;
         }

         function resetLessonForm() {
            document.getElementById("lesson-form-title").innerText =
               "Add New Lesson";
            document.getElementById("lesson-title").value = "";
            document.getElementById("lesson-video").value = "";
            document.getElementById("lesson-duration").value = "";
            document.getElementById("lesson-file").value = "";
            document.getElementById("add-lesson").innerText = "Add Lesson";
            document.getElementById("cancel-lesson-update").style.display =
               "none";
            document.getElementById("current-video-info").style.display =
               "none";
            selectedFiles = [];
            editingLessonNotes = [];
            document.getElementById("selected-files").innerHTML = "";
            editingLessonId = null;
         }

         function editLesson(lessonId, title, duration, notes) {
            editingLessonId = lessonId;
            editingLessonNotes = notes;

            document.getElementById("lesson-form-title").innerText =
               "Update Lesson";
            document.getElementById("lesson-title").value = title;
            document.getElementById("lesson-duration").value = duration;
            document.getElementById("lesson-video").value = "";
            document.getElementById("current-video-info").style.display =
               "block";
            document.getElementById("add-lesson").innerText = "Update Lesson";
            document.getElementById("cancel-lesson-update").style.display =
               "inline-block";

            // Scroll to form
            setTimeout(() => {
               document
                  .querySelector("#content-management .form-container")
                  .scrollIntoView({ behavior: "smooth" });
            }, 100);
         }

         async function deleteLesson(lessonId) {
            if (
               !confirm(
                  "Are you sure you want to delete this lesson? This will also delete the video and all notes."
               )
            ) {
               return;
            }

            try {
               await axiosInstance.delete(`/course/delete/lesson/${lessonId}`);
               alert("Lesson deleted successfully!");
               loadCourseContent(currentCourseId);
            } catch (error) {
               console.error("Failed to delete lesson:", error);
               alert(
                  "Failed to delete lesson: " +
                     (error.response?.data?.error || error.message)
               );
            }
         }

         async function deleteNote(noteId) {
            if (!confirm("Are you sure you want to delete this note?")) {
               return;
            }

            try {
               await axiosInstance.delete(`/course/delete/notes/${noteId}`);
               alert("Note deleted successfully!");
               loadCourseContent(currentCourseId);
            } catch (error) {
               console.error("Failed to delete note:", error);
               alert(
                  "Failed to delete note: " +
                     (error.response?.data?.error || error.message)
               );
            }
         }

         document.getElementById("add-files").addEventListener("click", () => {
            const fileInput = document.getElementById("lesson-file");
            const files = Array.from(fileInput.files);

            files.forEach((file) => {
               if (!validateFileSize(file, MAX_FILE_SIZE, "Note")) return;
               if (!selectedFiles.find((f) => f.name === file.name)) {
                  selectedFiles.push(file);
               }
            });

            displaySelectedFiles();
            fileInput.value = "";
         });

         document
            .getElementById("cancel-lesson-update")
            .addEventListener("click", () => {
               resetLessonForm();
            });

         function displaySelectedFiles() {
            const container = document.getElementById("selected-files");
            container.innerHTML = "";

            selectedFiles.forEach((file, index) => {
               const div = document.createElement("div");
               div.className = "note-item";
               div.innerHTML = `
               <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
               <button type="button" class="btn-danger" onclick="removeFile(${index})">Remove</button>
            `;
               container.appendChild(div);
            });
         }

         function removeFile(index) {
            selectedFiles.splice(index, 1);
            displaySelectedFiles();
         }

         document
            .getElementById("add-lesson")
            .addEventListener("click", async () => {
               const title = document
                  .getElementById("lesson-title")
                  .value.trim();
               const videoFile =
                  document.getElementById("lesson-video").files[0];
               const duration = parseInt(
                  document.getElementById("lesson-duration").value
               );

               if (!title || !duration || duration <= 0) {
                  alert("Please fill in title and duration (must be positive)");
                  return;
               }

               if (!editingLessonId && !videoFile) {
                  alert("Please select a video file for new lesson");
                  return;
               }

               if (
                  videoFile &&
                  !validateFileSize(videoFile, MAX_VIDEO_SIZE, "Video")
               ) {
                  return;
               }

               const button = document.getElementById("add-lesson");
               const originalText = button.textContent;
               button.disabled = true;
               button.textContent = editingLessonId
                  ? "Updating Lesson..."
                  : "Adding Lesson...";

               try {
                  if (editingLessonId) {
                     let updateData = { title, duration };

                     // Upload new video if provided
                     if (videoFile) {
                        const videoPresignRes = await axiosInstance.get(
                           `/s3/upload/lesson-video/pre-signed-url?courseId=${currentCourseId}&fileName=${encodeURIComponent(videoFile.name)}&fileType=${encodeURIComponent(videoFile.type)}`
                        );

                        await axios.put(videoPresignRes.data.url, videoFile, {
                           headers: { "Content-Type": videoFile.type },
                        });

                        updateData.videoKey = videoPresignRes.data.key;
                     }

                     // Upload and add new notes if any
                     if (selectedFiles.length > 0) {
                        const notes = [];
                        for (const file of selectedFiles) {
                           const filePresignRes = await axiosInstance.get(
                              `/s3/upload/lesson-file/pre-signed-url?courseId=${currentCourseId}&fileName=${encodeURIComponent(file.name)}&fileType=${encodeURIComponent(file.type)}`
                           );

                           await axios.put(filePresignRes.data.url, file, {
                              headers: { "Content-Type": file.type },
                           });

                           notes.push({
                              fileName: file.name,
                              fileKey: filePresignRes.data.key,
                              fileType: file.type,
                           });
                        }
                        updateData.notes = notes;
                     }

                     await axiosInstance.put(
                        `/course/${currentContentId}/${editingLessonId}/update`,
                        updateData
                     );

                     alert("Lesson updated successfully!");
                     resetLessonForm();
                     loadCourseContent(currentCourseId);
                  } else {
                     const videoPresignRes = await axiosInstance.get(
                        `/s3/upload/lesson-video/pre-signed-url?courseId=${currentCourseId}&fileName=${encodeURIComponent(videoFile.name)}&fileType=${encodeURIComponent(videoFile.type)}`
                     );

                     await axios.put(videoPresignRes.data.url, videoFile, {
                        headers: { "Content-Type": videoFile.type },
                     });

                     const notes = [];
                     for (const file of selectedFiles) {
                        const filePresignRes = await axiosInstance.get(
                           `/s3/upload/lesson-file/pre-signed-url?courseId=${currentCourseId}&fileName=${encodeURIComponent(file.name)}&fileType=${encodeURIComponent(file.type)}`
                        );

                        await axios.put(filePresignRes.data.url, file, {
                           headers: { "Content-Type": file.type },
                        });

                        notes.push({
                           fileName: file.name,
                           fileKey: filePresignRes.data.key,
                           fileType: file.type,
                        });
                     }

                     const lessonData = {
                        title,
                        videoKey: videoPresignRes.data.key,
                        duration,
                        notes,
                     };

                     const response = await axiosInstance.post(
                        `/course/${currentCourseId}/lesson`,
                        lessonData
                     );

                     alert(
                        `Lesson added successfully! Total lessons: ${response.data.totalLessons}`
                     );
                     resetLessonForm();
                     loadCourseContent(currentCourseId);
                  }
               } catch (error) {
                  console.error("Failed to save lesson:", error);
                  alert(
                     "Failed to save lesson: " +
                        (error.response?.data?.error || error.message)
                  );
               } finally {
                  button.disabled = false;
                  button.textContent = originalText;
               }
            });

         async function deleteCourse(courseId) {
            if (
               !confirm(
                  "Are you sure you want to delete this course? All content will be permanently deleted."
               )
            )
               return;

            try {
               const res = await axiosInstance.delete(
                  `/course/delete/${courseId}`
               );
               alert(res.data.message || "Course deleted!");
               loadCourses();
            } catch (error) {
               console.error(
                  "Delete failed:",
                  error.response?.data || error.message
               );
               alert(
                  "Failed to delete course: " +
                     (error.response?.data?.error || error.message)
               );
            }
         }

         document
            .getElementById("submit-course")
            .addEventListener("click", async () => {
               const button = document.getElementById("submit-course");
               button.disabled = true;

               const title = document.getElementById("title").value.trim();
               const description = document
                  .getElementById("description")
                  .value.trim();
               const price = Number(document.getElementById("price").value);
               const file = document.getElementById("thumbnail-image").files[0];

               if (!title || !description || isNaN(price) || price < 0) {
                  alert("Please fill all required fields with valid values.");
                  button.disabled = false;
                  return;
               }

               if (file && !validateFileSize(file, MAX_IMAGE_SIZE, "Image")) {
                  button.disabled = false;
                  return;
               }

               let key = null;
               try {
                  let updateData = { title, description, price };

                  if (file) {
                     const presignRes = await axiosInstance.get(
                        `/s3/upload/thumbnail/pre-signed-url?courseName=${encodeURIComponent(title)}&fileName=${encodeURIComponent(file.name)}&fileType=${encodeURIComponent(file.type)}`
                     );
                     key = presignRes.data.key;
                     const { url } = presignRes.data;

                     await axios.put(url, file, {
                        headers: { "Content-Type": file.type },
                     });
                     updateData.key = key;
                  }

                  if (editingCourseId) {
                     const res = await axiosInstance.put(
                        `/course/update/${editingCourseId}`,
                        updateData
                     );
                     alert(res.data.message || "Course updated!");
                  } else {
                     if (!file) {
                        alert("Please select a thumbnail for new course.");
                        button.disabled = false;
                        return;
                     }

                     const res = await axiosInstance.post(
                        "/course/create",
                        updateData
                     );
                     alert(res.data.message || "Course created!");
                  }

                  resetForm();
                  loadCourses();
               } catch (error) {
                  console.error(
                     "Operation failed:",
                     error.response?.data || error.message
                  );
                  if (key) {
                     await axiosInstance.delete(`/s3/delete?key=${key}`);
                  }
                  alert(
                     "Operation failed: " +
                        (error.response?.data?.error || error.message)
                  );
               } finally {
                  button.disabled = false;
               }
            });

         document
            .getElementById("cancel-update")
            .addEventListener("click", resetForm);
         document
            .getElementById("back-to-courses")
            .addEventListener("click", showCourseList);

         loadCourses();
      </script>
   </body>
</html>

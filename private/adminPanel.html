<!doctype html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <title>Course Admin Panel</title>
      <style>
         body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
         }
         h2,
         h3 {
            color: #333;
         }
         .form-container,
         .course-list {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
         }
         .form-container input,
         .form-container textarea,
         .form-container select,
         .form-container button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
         }
         .form-container textarea {
            resize: vertical;
            min-height: 100px;
         }
         .form-container button {
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: 0.2s;
         }
         .form-container button:hover {
            background-color: #0056b3;
         }
         .course-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
         }
         .course-card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
         }
         .course-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
         }
         .course-card .content {
            padding: 15px;
            flex-grow: 1;
         }
         .course-card h4 {
            margin: 0 0 10px 0;
            color: #333;
         }
         .course-card p {
            margin: 5px 0;
            color: #555;
            font-size: 14px;
         }
         .course-card .actions {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-top: 1px solid #eee;
         }
         .course-card .actions button {
            flex: 1;
            margin: 0 5px;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
         }
         .update-btn {
            background-color: #ffc107;
            color: #fff;
         }
         .update-btn:hover {
            background-color: #e0a800;
         }
         .delete-btn {
            background-color: #dc3545;
            color: #fff;
         }
         .delete-btn:hover {
            background-color: #c82333;
         }
         .content-btn {
            background-color: #28a745;
            color: #fff;
         }
         .content-btn:hover {
            background-color: #218838;
         }
         #cancel-update {
            background-color: #6c757d;
         }
         #cancel-update:hover {
            background-color: #5a6268;
         }
         .hidden {
            display: none !important;
         }
         .content-management {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
         }
         .lesson-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
         }
         .lesson-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
         }
         .notes-list {
            margin-top: 10px;
         }
         .note-item {
            background: #e9ecef;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
         }
         .file-input-group {
            display: flex;
            gap: 10px;
            align-items: end;
         }
         .file-input-group input[type="file"] {
            flex: 1;
            margin: 0;
         }
         .file-input-group button {
            margin: 0;
            padding: 10px 15px;
            white-space: nowrap;
            width: auto;
         }
         .back-btn {
            background-color: #6c757d;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
         }
         .back-btn:hover {
            background-color: #5a6268;
         }
         .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
         }
         .remove-btn:hover {
            background-color: #c82333;
         }
      </style>
   </head>
   <body>
      <h2>Course Admin Panel</h2>

      <!-- Course Creation/Update Form -->
      <div class="form-container" id="course-form">
         <h3 id="form-title">Create Course</h3>
         <input type="text" id="title" placeholder="Course Title" />
         <input type="text" id="description" placeholder="Course Description" />
         <input type="number" id="price" placeholder="Course Price" />
         <input type="file" id="thumbnail-image" />
         <button id="submit-course">Create Course</button>
         <button id="cancel-update" style="display: none">Cancel Update</button>
      </div>

      <!-- Course Content Management -->
      <div class="content-management hidden" id="content-management">
         <button class="back-btn" id="back-to-courses">
            ‚Üê Back to Courses
         </button>
         <h3 id="content-course-title">Manage Course Content</h3>

         <div class="form-container">
            <h4>Add New Lesson</h4>
            <input type="text" id="lesson-title" placeholder="Lesson Title" />
            <input type="file" id="lesson-video" accept="video/*" />
            <input
               type="number"
               id="lesson-duration"
               placeholder="Duration (minutes)"
            />

            <h5>Add Notes/Files</h5>
            <div class="file-input-group">
               <input
                  type="file"
                  id="lesson-file"
                  multiple
                  accept=".pdf,.txt,.md,.docx,.pptx,.jpg,.jpeg,.png,.json,.html"
               />
               <button type="button" id="add-files">Add Files</button>
            </div>

            <div id="selected-files"></div>

            <button id="add-lesson">Add Lesson</button>
         </div>

         <div id="lessons-list">
            <h4>Course Lessons</h4>
            <div id="lessons-container"></div>
         </div>
      </div>

      <!-- Course List -->
      <div class="course-list" id="course-list"></div>

      <script>
         const backendUrl = "http://localhost:3000";
         let editingCourseId = null;
         let currentCourseId = null;
         let selectedFiles = [];

         // Fetch all courses and render
         async function loadCourses() {
            try {
               const res = await axios.get(
                  `${backendUrl}/api/v1/course/preview`,
                  { withCredentials: true }
               );
               const courses = res.data.courses;
               const courseList = document.getElementById("course-list");
               courseList.innerHTML = "";

               courses.forEach((course) => {
                  const div = document.createElement("div");
                  div.className = "course-card";
                  div.innerHTML = `
                  <img src="${course["thumbnail-image"]?.url || "https://via.placeholder.com/250x160?text=No+Image"}" alt="thumbnail"/>
                  <div class="content">
                     <h4>${course.title}</h4>
                     <p>${course.description}</p>
                     <p><strong>Price:</strong> $${course.price}</p>
                  </div>
                  <div class="actions">
                     <button class="update-btn" data-id="${course._id}">Update</button>
                     <button class="content-btn" data-id="${course._id}" data-title="${course.title}">Add Content</button>
                     <button class="delete-btn" data-id="${course._id}" data-key="${course["thumbnail-image"]?.key || ""}">Delete</button>
                  </div>
               `;
                  courseList.appendChild(div);
               });

               // Attach event listeners
               document.querySelectorAll(".update-btn").forEach((btn) => {
                  btn.addEventListener("click", (e) => {
                     const courseId = e.target.dataset.id;
                     const course = courses.find((c) => c._id === courseId);
                     startUpdate(courseId, course);
                  });
               });

               document.querySelectorAll(".content-btn").forEach((btn) => {
                  btn.addEventListener("click", (e) => {
                     const courseId = e.target.dataset.id;
                     const courseTitle = e.target.dataset.title;
                     showContentManagement(courseId, courseTitle);
                  });
               });

               document.querySelectorAll(".delete-btn").forEach((btn) => {
                  btn.addEventListener("click", async (e) => {
                     const courseId = e.target.dataset.id;
                     await deleteCourse(courseId);
                  });
               });
            } catch (error) {
               console.error(
                  "Failed to load courses:",
                  error.response?.data || error.message
               );
            }
         }

         function showContentManagement(courseId, courseTitle) {
            currentCourseId = courseId;
            document.getElementById("course-form").classList.add("hidden");
            document.getElementById("course-list").classList.add("hidden");
            document
               .getElementById("content-management")
               .classList.remove("hidden");
            document.getElementById("content-course-title").textContent =
               `Manage Content: ${courseTitle}`;
            loadCourseContent(courseId);
         }

         function showCourseList() {
            document.getElementById("course-form").classList.remove("hidden");
            document.getElementById("course-list").classList.remove("hidden");
            document
               .getElementById("content-management")
               .classList.add("hidden");
            currentCourseId = null;
         }

         async function loadCourseContent(courseId) {
            try {
               const res = await axios.get(
                  `${backendUrl}/api/v1/course/${courseId}/content`,
                  {
                     withCredentials: true,
                  }
               );

               const content = res.data;
               const container = document.getElementById("lessons-container");

               if (content.lessons && content.lessons.length > 0) {
                  container.innerHTML = content.lessons
                     .map(
                        (lesson, index) => `
            <div class="lesson-item">
               <h4>Lesson ${index + 1}: ${lesson.title}</h4>
               <p><strong>Duration:</strong> ${lesson.duration} minutes</p>
               <p><strong>Video:</strong> ${lesson.video.key}</p>
               <p><strong>Notes:</strong> ${lesson.notes.length} files</p>
               <div class="notes-list">
                  ${lesson.notes
                     .map(
                        (note) => `
                     <div class="note-item">
                        <span>${note.fileName}</span>
                     </div>
                  `
                     )
                     .join("")}
               </div>
            </div>
         `
                     )
                     .join("");
               } else {
                  container.innerHTML = "<p>No lessons added yet.</p>";
               }
            } catch (error) {
               console.error("Failed to load course content:", error);
               if (error.response?.status === 403) {
                  document.getElementById("lessons-container").innerHTML =
                     "<p>This course has no content yet.</p>";
               } else {
                  document.getElementById("lessons-container").innerHTML =
                     "<p>Error loading course content.</p>";
               }
            }
         }

         function startUpdate(courseId, course) {
            editingCourseId = courseId;
            document.getElementById("form-title").innerText = "Update Course";
            document.getElementById("title").value = course.title;
            document.getElementById("description").value = course.description;
            document.getElementById("price").value = course.price;
            document.getElementById("submit-course").innerText =
               "Update Course";
            document.getElementById("cancel-update").style.display =
               "inline-block";
         }

         document
            .getElementById("cancel-update")
            .addEventListener("click", () => {
               editingCourseId = null;
               resetForm();
            });

         document
            .getElementById("back-to-courses")
            .addEventListener("click", showCourseList);

         function resetForm() {
            document.getElementById("form-title").innerText = "Create Course";
            document.getElementById("title").value = "";
            document.getElementById("description").value = "";
            document.getElementById("price").value = "";
            document.getElementById("thumbnail-image").value = "";
            document.getElementById("submit-course").innerText =
               "Create Course";
            document.getElementById("cancel-update").style.display = "none";
         }

         function resetLessonForm() {
            document.getElementById("lesson-title").value = "";
            document.getElementById("lesson-video").value = "";
            document.getElementById("lesson-duration").value = "";
            document.getElementById("lesson-file").value = "";
            selectedFiles = [];
            document.getElementById("selected-files").innerHTML = "";
         }

         // File handling
         document.getElementById("add-files").addEventListener("click", () => {
            const fileInput = document.getElementById("lesson-file");
            const files = Array.from(fileInput.files);

            files.forEach((file) => {
               if (!selectedFiles.find((f) => f.name === file.name)) {
                  selectedFiles.push(file);
               }
            });

            displaySelectedFiles();
         });

         function displaySelectedFiles() {
            const container = document.getElementById("selected-files");
            container.innerHTML = "";

            selectedFiles.forEach((file, index) => {
               const div = document.createElement("div");
               div.className = "note-item";
               div.innerHTML = `
                  <span>${file.name} (${file.type})</span>
                  <button type="button" class="remove-btn" onclick="removeFile(${index})">Remove</button>
               `;
               container.appendChild(div);
            });
         }

         function removeFile(index) {
            selectedFiles.splice(index, 1);
            displaySelectedFiles();
         }

         // Add lesson
         document
            .getElementById("add-lesson")
            .addEventListener("click", async () => {
               const title = document
                  .getElementById("lesson-title")
                  .value.trim();
               const videoFile =
                  document.getElementById("lesson-video").files[0];
               const duration = parseInt(
                  document.getElementById("lesson-duration").value
               );

               if (!title || !videoFile || !duration) {
                  alert(
                     "Please fill in all lesson fields including video file"
                  );
                  return;
               }

               const button = document.getElementById("add-lesson");
               button.disabled = true;
               button.textContent = "Adding Lesson...";

               try {
                  // Upload video first
                  const videoPresignRes = await axios.get(
                     `${backendUrl}/api/v1/s3/upload/lesson-video/pre-signed-url?courseId=${currentCourseId}&fileName=${encodeURIComponent(videoFile.name)}&fileType=${encodeURIComponent(videoFile.type)}`,
                     { withCredentials: true }
                  );

                  await axios.put(videoPresignRes.data.url, videoFile, {
                     headers: { "Content-Type": videoFile.type },
                  });

                  // Upload notes files
                  const notes = [];
                  for (const file of selectedFiles) {
                     const filePresignRes = await axios.get(
                        `${backendUrl}/api/v1/s3/upload/lesson-file/pre-signed-url?courseId=${currentCourseId}&fileName=${encodeURIComponent(file.name)}&fileType=${encodeURIComponent(file.type)}`,
                        { withCredentials: true }
                     );

                     await axios.put(filePresignRes.data.url, file, {
                        headers: { "Content-Type": file.type },
                     });

                     notes.push({
                        fileName: file.name,
                        fileKey: filePresignRes.data.key,
                        fileType: file.type,
                     });
                  }

                  // Add lesson to course
                  const lessonData = {
                     title,
                     videoKey: videoPresignRes.data.key,
                     duration,
                     notes,
                  };

                  const response = await axios.post(
                     `${backendUrl}/api/v1/course/${currentCourseId}/lesson`,
                     lessonData,
                     { withCredentials: true }
                  );

                  alert(
                     `Lesson added successfully! Total lessons: ${response.data.totalLessons}`
                  );
                  resetLessonForm();
                  loadCourseContent(currentCourseId);
               } catch (error) {
                  console.error("Failed to add lesson:", error);
                  alert(
                     "Failed to add lesson: " +
                        (error.response?.data?.error || error.message)
                  );
               } finally {
                  button.disabled = false;
                  button.textContent = "Add Lesson";
               }
            });

         async function deleteCourse(courseId) {
            if (!confirm("Are you sure you want to delete this course?"))
               return;

            try {
               const res = await axios.delete(
                  `${backendUrl}/api/v1/course/delete/${courseId}`,
                  { withCredentials: true }
               );
               alert(res.data.message || "Course deleted!");
               loadCourses();
            } catch (error) {
               console.error(
                  "Delete failed:",
                  error.response?.data || error.message
               );
               alert("Failed to delete course.");
            }
         }

         document
            .getElementById("submit-course")
            .addEventListener("click", async () => {
               const button = document.getElementById("submit-course");
               button.disabled = true;

               const title = document.getElementById("title").value.trim();
               const description = document
                  .getElementById("description")
                  .value.trim();
               const price = Number(document.getElementById("price").value);
               const file = document.getElementById("thumbnail-image").files[0];

               if (!title || !description || isNaN(price)) {
                  alert("Please fill all required fields.");
                  button.disabled = false;
                  return;
               }

               let key = null;
               try {
                  let updateData = { title, description, price };

                  if (file) {
                     const presignRes = await axios.get(
                        `${backendUrl}/api/v1/s3/upload/thumbnail/pre-signed-url?courseName=${encodeURIComponent(title)}&fileName=${encodeURIComponent(file.name)}&fileType=${encodeURIComponent(file.type)}`,
                        { withCredentials: true }
                     );
                     key = presignRes.data.key;
                     const { url } = presignRes.data;

                     await axios.put(url, file, {
                        headers: { "Content-Type": file.type },
                     });
                     updateData.key = key;
                  }

                  if (editingCourseId) {
                     const res = await axios.put(
                        `${backendUrl}/api/v1/course/update/${editingCourseId}`,
                        updateData,
                        { withCredentials: true }
                     );
                     alert(res.data.message || "Course updated!");
                     editingCourseId = null;
                  } else {
                     if (!file) {
                        alert("Please select a thumbnail for new course.");
                        button.disabled = false;
                        return;
                     }

                     const res = await axios.post(
                        `${backendUrl}/api/v1/course/create`,
                        updateData,
                        { withCredentials: true }
                     );
                     alert(res.data.message || "Course created!");
                  }

                  resetForm();
                  loadCourses();
               } catch (error) {
                  console.error(
                     "Operation failed:",
                     error.response?.data || error.message
                  );
                  if (key) {
                     const deleteOrphanfile = await axios.delete(
                        `${backendUrl}/api/v1/s3/delete?key=${key}`
                     );
                     console.log(
                        "deleted",
                        deleteOrphanfile,
                        deleteOrphanfile.status
                     );
                  }
                  alert("Operation failed, please try again.");
               } finally {
                  button.disabled = false;
               }
            });

         // Load courses on page load
         loadCourses();
      </script>
   </body>
</html>

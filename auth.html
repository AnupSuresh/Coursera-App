<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <title>Auth with MongoDB</title>
   </head>
   <body>
      <div id="loggedOutDiv" hidden>
         <div>
            <h4>SignUP</h4>
            <label for="su_name">Name: </label>
            <input type="text" name="name" id="su_name" />
            <br />
            <br />
            <label for="su_email">Email: </label>
            <input type="email" name="email" id="su_email" />
            <br />
            <br />
            <label for="su_password">Password: </label>
            <input type="text" name="password" id="su_password" />
            <br />
            <br />
            <!-- <input
               type="text"
               name="adminSecret"
               value="iamanadmin"
               id="adminSecret"
               hidden
            /> -->
            <button onclick="SignUp()">Sign Up</button>
         </div>
         <div>
            <h4>SignIN</h4>
            <label for="si_email">Email: </label>
            <input type="email" name="email" id="si_email" />
            <br />
            <br />
            <label for="si_password">Password: </label>
            <input type="text" name="password" id="si_password" />
            <br />
            <br />
            <button onclick="SignIn()">Sign In</button>
         </div>
      </div>
      <div id="statusDiv">
         <h5>Status: <b id="status" style="color: red">LOGGED OUT</b></h5>
      </div>
      <div hidden id="userInfoDiv">
         <h4>User Info:</h4>
         <p>Id: <i id="userId"></i></p>
         <p>Name: <i id="userName"></i></p>
         <p>Email: <i id="userEmail"></i></p>
         <p>Role: <i id="userRole"></i></p>
         <button onclick="redirectToAdminPanel()">Admin Panel</button>
         <button onclick="redirectToSuperAdminPanel()">
            Super Admin Panel
         </button>
         <button onclick="LogOut()">Log out</button>
      </div>
      <script>
         const SignUp = async () => {
            try {
               const name = document.getElementById("su_name").value;
               const email = document.getElementById("su_email").value;
               const password = document.getElementById("su_password").value;
               const adminSecret =
                  document.getElementById("adminSecret")?.value;
               // console.log(adminSecret);
               const response = await axios.post(
                  "http://localhost:3000/auth/signup",
                  {
                     name: name,
                     email: email,
                     password: password,
                     adminSecret: adminSecret,
                  }
               );
               alert(response.data.message);
            } catch (error) {
               const errorData = error.response?.data?.error?.properties;

               if (errorData) {
                  const errors = [];

                  for (const [field, info] of Object.entries(errorData)) {
                     if (Array.isArray(info.errors)) {
                        errors.push(`${field}: ${info.errors.join(", ")}`);
                     }
                  }
                  alert("Validation Errors:\n" + errors.join("\n"));
               } else if (typeof error.response?.data?.error === "string") {
                  alert("Error: " + error.response.data.error);
               } else {
                  alert(
                     "An unexpected error occurred. Please try again later."
                  );
                  console.error("Unhandled error:", error);
               }
            }
         };

         const SignIn = async () => {
            try {
               const email = document.getElementById("si_email").value;
               const password = document.getElementById("si_password").value;
               const response = await axios.post(
                  "http://localhost:3000/auth/signin",
                  {
                     email: email,
                     password: password,
                  },
                  { withCredentials: true }
               );
               console.log(response.data.message);
               alert(response.data.message);
               getUserData();
            } catch (error) {
               if (error.response) {
                  alert(error.response.data.error);
               } else {
                  alert("Network error or server not reachable");
               }
            }
         };

         const LogOut = async () => {
            try {
               const userInfoDiv = document.getElementById("userInfoDiv");
               const loggedOutDiv = document.getElementById("loggedOutDiv");
               const status = document.getElementById("status");
               const response = await axios.post(
                  "http://localhost:3000/auth/logout",
                  {},
                  {
                     withCredentials: true,
                  }
               );
               alert(response.data.message);
               userInfoDiv.hidden = true;
               loggedOutDiv.hidden = false;
               status.textContent = "LOGGED OUT";
               status.style.color = "red";
            } catch (error) {
               console.error("Logout failed:", error);
               alert("Logout failed:", error);
            }
         };

         const getUserData = async () => {
            try {
               const response = await axios.get(
                  "http://localhost:3000/auth/me",
                  {
                     withCredentials: true,
                  }
               );
               if (response.data?.user) {
                  const userInfoDiv = document.getElementById("userInfoDiv");
                  const loggedOutDiv = document.getElementById("loggedOutDiv");
                  const userId = document.getElementById("userId");
                  const userName = document.getElementById("userName");
                  const userEmail = document.getElementById("userEmail");
                  const userRole = document.getElementById("userRole");
                  const status = document.getElementById("status");
                  userInfoDiv.hidden = false;
                  loggedOutDiv.hidden = true;
                  userId.textContent = response.data.user._id;
                  userName.textContent = response.data.user.name;
                  userEmail.textContent = response.data.user.email;
                  userRole.textContent = response.data.user.role;
                  status.textContent = "LOGGED IN";
                  status.style.color = "green";
               }
            } catch (error) {
               document.getElementById("userInfoDiv").hidden = true;
               document.getElementById("loggedOutDiv").hidden = false;
               if (error.response) {
                  if (error.response.data.error === "No token provided") {
                     return;
                  }
                  alert(error.response.data.error);
               } else {
                  alert("Network error or server not reachable");
               }
            }
         };

         function redirectToAdminPanel() {
            window.location.href = "/auth/admin";
         }
         function redirectToSuperAdminPanel() {
            window.location.href = "/auth/super-admin";
         }

         document.addEventListener("DOMContentLoaded", () => {
            getUserData();
         });
      </script>
   </body>
</html>

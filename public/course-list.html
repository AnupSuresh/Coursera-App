<!doctype html>
<html>
   <head>
      <title>Available Courses</title>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <style>
         body {
            font-family: Arial, sans-serif;
            margin: 20px;
         }
         .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
         }
         .course-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
         }
         .course-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
         }
         .course-card h3 {
            margin: 15px 0 10px 0;
            color: #333;
         }
         .course-card p {
            color: #666;
            margin: 10px 0;
         }
         .price {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
         }
         .button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-size: 14px;
            margin: 5px;
         }
         .btn-primary {
            background: #007bff;
            color: white;
         }
         .btn-success {
            background: #28a745;
            color: white;
         }
         .btn-info {
            background: #17a2b8;
            color: white;
         }
         .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
         }
         .loading {
            text-align: center;
            padding: 40px;
         }
      </style>
   </head>
   <body>
      <div class="user-info">
         <div id="user-status">Loading user information...</div>
      </div>

      <h1>Available Courses</h1>
      <div id="courses-container" class="loading">Loading courses...</div>

      <script>
         let currentUser = null;
         let ownedCourseIds = [];

         async function loadUserInfo() {
            try {
               const response = await axios.get("/api/v1/user/me", {
                  withCredentials: true,
               });
               currentUser = response.data.user;

               // Load owned courses
               const ownedResponse = await axios.get("/api/v1/course/owned", {
                  withCredentials: true,
               });
               ownedCourseIds = ownedResponse.data.courses.map((c) => c._id);

               document.getElementById("user-status").innerHTML = `
                <strong>Welcome, ${currentUser.firstName} ${currentUser.lastName}!</strong>
                <span style="margin-left: 20px;">Role: ${currentUser.role}</span>
                <span style="margin-left: 20px;">Owned Courses: ${ownedCourseIds.length}</span>
                <button onclick="logout()" style="margin-left: 20px; padding: 5px 10px;">Logout</button>
            `;
            } catch (error) {
               document.getElementById("user-status").innerHTML = `
                <span>Not logged in</span>
                <a href="/" style="margin-left: 20px;">Login</a>
            `;
            }
         }

         async function loadCourses() {
            try {
               const response = await axios.get("/api/v1/course/preview");
               const courses = response.data.courses;

               const container = document.getElementById("courses-container");

               if (courses.length === 0) {
                  container.innerHTML = "<p>No courses available.</p>";
                  return;
               }

               container.className = "course-grid";
               container.innerHTML = courses
                  .map((course) => {
                     const isOwned = ownedCourseIds.includes(course._id);
                     const canManage =
                        currentUser && currentUser.role === "admin";

                     return `
                    <div class="course-card">
                        <img src="${course["thumbnail-image"]?.url || "https://via.placeholder.com/300x200?text=No+Image"}" 
                             alt="${course.title}">
                        <h3>${course.title}</h3>
                        <p>${course.description}</p>
                        <div class="price">${course.price}</div>
                        
                        <div style="margin-top: 15px;">
                            ${
                               isOwned
                                  ? `
                                <a href="course-viewer.html?courseId=${course._id}" class="button btn-success">
                                    View Content
                                </a>
                            `
                                  : `
                                <button onclick="purchaseCourse('${course._id}')" class="button btn-primary">
                                    Purchase Course
                                </button>
                            `
                            }
                            
                            ${
                               canManage
                                  ? `
                                <a href="/api/v1/user/admin" class="button btn-info">
                                    Manage
                                </a>
                            `
                                  : ""
                            }
                        </div>
                        
                        ${isOwned ? '<div style="color: #28a745; margin-top: 10px; font-weight: bold;">âœ“ Owned</div>' : ""}
                    </div>
                `;
                  })
                  .join("");
            } catch (error) {
               console.error("Failed to load courses:", error);
               document.getElementById("courses-container").innerHTML =
                  "<p>Error loading courses.</p>";
            }
         }

         async function purchaseCourse(courseId) {
            if (!currentUser) {
               alert("Please log in first");
               window.location.href = "/";
               return;
            }

            try {
               const response = await axios.post(
                  `/api/v1/course/purchase/${courseId}`,
                  {},
                  {
                     withCredentials: true,
                  }
               );

               alert("Course purchased successfully!");
               // Reload to update owned courses
               await loadUserInfo();
               await loadCourses();
            } catch (error) {
               console.error("Purchase failed:", error);
               alert(
                  "Purchase failed: " +
                     (error.response?.data?.error || "Unknown error")
               );
            }
         }

         async function logout() {
            try {
               await axios.post(
                  "/api/v1/user/signOut",
                  {},
                  { withCredentials: true }
               );
               window.location.reload();
            } catch (error) {
               console.error("Logout failed:", error);
            }
         }

         // Load everything on page load
         async function init() {
            await loadUserInfo();
            await loadCourses();
         }

         init();
      </script>
   </body>
</html>
